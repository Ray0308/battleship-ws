// =======================
// 必要モジュール
// =======================
const express = require("express");
const path = require("path");
const http = require("http");
const WebSocket = require("ws");

// =======================
// サーバ基盤
// =======================
const app = express();
const server = http.createServer(app);

// WebSocketサーバ
const wss = new WebSocket.Server({ server });

// public 配信
app.use(express.static(path.join(__dirname, "public")));

let players = []; // { ws, id }

// =======================
// WebSocket処理
// =======================
wss.on("connection", (ws) => {
  console.log("クライアント が接続されました");

  // --- プレイヤーIDの割り振り ---
  const id = players.length === 0 ? "p1" : "p2";
  players.push({ ws, id });

  // クライアントへプレイヤーIDを通知
  ws.send(JSON.stringify({ type: "assign", id }));

  // --- ２人揃ったら対戦開始 ---
  if (players.length === 2) {
    players.forEach((p) => {
      p.ws.send(JSON.stringify({ type: "ready" }));
    });
  }

  // --- メッセージ受信時 ---
  ws.on("message", (msg) => {
    // 受け取ったデータを相手に送る
    players.forEach((p) => {
      if (p.ws !== ws && p.ws.readyState === WebSocket.OPEN) {
        p.ws.send(msg.toString());
      }
    });
  });

  // --- 切断時 ---
  ws.on("close", () => {
    console.log("クライアント が切断されました");
    players = players.filter((p) => p.ws !== ws);

    // 切断を通知
    players.forEach((p) => {
      p.ws.send(JSON.stringify({ type: "disconnect" }));
    });
  });
});

// =======================
// Render / ローカル両対応
// =======================
const PORT = process.env.PORT || 8080;
server.listen(PORT, () => console.log("Server running on " + PORT));
